---
title: "Usando Regressão Linear para Explicar a votação de Deputados"
author: "Matheus Leal"
date: "11 de outubro de 2018"
output: html_document
---

```{r message=FALSE,  warning=FALSE}
library(here)
library(tidyverse)

```

##Introdução
#####Esta análise utilizará conceitos de regressão linear para tentar explicar as votações que os deputados receberam em 2006 e 2010. Esses dados foram extraídos do TSE, pré-processados e contemplam informações sobre aproximadamente 7.300 candidatos.
#####Primeiro, vamos importar os dados referentes às eleições. Antes de utilizar os dados, iremos realizar alguns ajustes, tais quais tratamento de NAs e alterar os tipos de algumas variáveis de factor para character.
```{r message=FALSE,  warning=FALSE}
eleicoes_data <- read_csv(here('lab-03/eleicoes_2006_e_2010.csv'),
    col_types = cols(
      ano = col_integer(),
      sequencial_candidato = col_character(),
      quantidade_doacoes = col_integer(),
      quantidade_doadores = col_integer(),
      total_receita = col_double(),
      media_receita = col_double(),
      recursos_de_outros_candidatos.comites = col_double(),
      recursos_de_pessoas_fisicas = col_double(),
      recursos_de_pessoas_juridicas = col_double(),
      recursos_proprios = col_double(),
      `recursos_de_partido_politico` = col_double(),
      quantidade_despesas = col_integer(),
      quantidade_fornecedores = col_integer(),
      total_despesa = col_double(),
      media_despesa = col_double(),
      votos = col_integer(),
      .default = col_character()))

dados <- na.omit(eleicoes_data) %>%   mutate(nome = as.character(nome),
         uf = as.character(uf),
         partido = as.character(partido),
         cargo = as.character(cargo),
         sexo = as.character(sexo),
         grau = as.character(grau),
         estado_civil = as.character(estado_civil),
         ocupacao = as.character(ocupacao)
         )

```


##Perguntas


#####Antes de qualquer coisa, abaixo um visão geral dos dados, quais colunas o data frame contém e o que significam.
```{r message=FALSE,  warning=FALSE}
dados %>%  glimpse()

```


###Descrição dos Dados
####O significado das variáveis:

#####"sequencial_candidato" :(character) id do candidato

#####"nome": (character)

#####"uf": (character)

#####"partido": (character)

#####"quantidade_doacoes": (integer)

#####"quantidade_doadores": (integer) número de doadores diferentes

#####"total_receita": (double) soma em R$ das doações

#####"media_receita": (double) média das doações

#####"recursos_de_outros_candidatos/comites": (double) quantia em R$ das doações provenientes de outros candidatos ou comite partidário

#####"recursos_de_pessoas_fisicas": (double) quantia em R$ das doações provenientes de outros CPFs

#####"recursos_de_pessoas_juridicas": (double) quantia em R$ das doações provenientes de outros CNPJ

#####"recursos_proprios": (double) quantia em R$ das doações provenientes do próprio candidato

#####"recursos_de_partido_politico": (double) quantia em R$ das doações provenientes do partido político do candidato

#####"votos": (integer) variável alvo. Se refere ao número de votos na campanha de 2006 e 2010

#####"quantidade_despesas": (integer)

#####"quantidade_fornecedores": (integer) número de fornecedores/despesas diferentes

#####"total_despesa": (double) soma em R$ das despesas de campanha

#####"media_despesa": (double) média das despesas de campanha

#####"cargo": (character)

#####"Sexo":  (character)

#####"grau": (character) grau de instrução do candidato

#####"estado_civil": (character)

#####"ocupacao": (character) ocupação do candidato


### 1. Um modelo de regressão múltipla com todas as variáveis é plausível para explicar a variação em y (número de votos) em 2006? Mesma pergunta para 2010.

#####Antes, iremos retirar algumas varíveis dos nosso modelo que não se mostram tão interessantes para nossa análise, como nome do candidato, seu cargo (tendo em vista que todos são iguais), ano da eleição, ocupação e o sequencial dos candidatos.


```{r message=FALSE,  warning=FALSE}
eleicoes_2006 <- dados %>% filter(ano == "2006") %>% select(-nome, -sequencial_candidato, -cargo, -ano, -ocupacao, -uf)

modelo <- lm(data = eleicoes_2006, votos ~ ., na.action = na.omit)

modelo %>%   summary()

```


#####Para 2006, observamos que nosso R quadrado explica por volto de 54% dos dados, não é tão ruim, mas também não é dos melhores.


```{r message=FALSE,  warning=FALSE}
eleicoes_2010 <- dados %>% filter(ano == "2010") %>% select(-nome, -sequencial_candidato, -cargo, -ano, -ocupacao, -uf)

modelo2 <- lm(data = eleicoes_2010, votos ~ ., na.action = na.omit)

modelo2 %>%   summary()

```


#####Para 2010, observamos que nosso R quadrado explica por volto de 47% dos dados, o que é pior que o do ano de 2006.

#####Agora, vamos complementar nossa primeira análise com os graficos:

```{r message=FALSE,  warning=FALSE}
modelo %>%
  ggplot(aes(.fitted, .resid)) + 
  geom_point() +
  stat_smooth(method="loess") + 
  geom_hline(col="red",
             yintercept = 0,
             linetype="dashed") + 
  labs(y="Resíduos",
       x="Valores Ajustados",
       title="Resíduos vs Valores Ajustados Plot (2006)")


modelo2 %>%
  ggplot(aes(.fitted, .resid)) + 
  geom_point() +
  stat_smooth(method="loess") + 
  geom_hline(col="red",
             yintercept = 0,
             linetype="dashed") + 
  labs(y="Resíduos",
       x="Valores Ajustados",
       title="Resíduos vs Valores Ajustados Plot (2010)")

```



#####Em ambos os gráficos, temos muitos pontos afastados da reta, o que nos diz que o modelo não se adequa tão bem aos dados.



### 2. Compare as regressões construídas para 2006 e 2010. Quais as diferenças/semelhanças percebidas?

#####Fazendo uma breve análise, os gráficos se mostram assimétricos e com um comportamento não aleatório, o que implica num modelo não ideal. 

#####As variáveis que mais explicam os modelos apresentam poucas diferenças. Para 2006 temos que  total_receita é bastante explicativa para o modelo, enquanto que para 2010 não é, já a variável recursos_próprios é bastante explicativa para o modelo em 2010, quando para 2006 não é.
#####Variáveis mais explicativas para 2006: recursos_de_pessoas_juridicas, recursos_de_pessoas_fisicas, total_despesa. Variáveis mais explicativas para 2010:  recursos_de_pessoas_fisicas, recursos_proprios, total_despesa, media_receita. As menos explicativas para 2006: quantidade_doacoes, uf,  quantidade_fornecedores. Para 2010: quantidade_doacoes, quantidade_doadores, total_receita.


### 3. Todas as variáveis são úteis para os modelos de regressão? Há variáveis redudantes? Faça análises para 2006 e 2010 separadamente
#####Iremos tirar do nosso modelo todas as variáveis categoricas, para que possamos analisar a correlação entre as variáveis quantitativas.
```{r message=FALSE,  warning=FALSE}
library(GGally)
el2006 <- eleicoes_2006 %>% select(-partido, -estado_civil, -sexo, -grau)

corr = el2006[, 0:14] %>%  cor() %>%  round(2)

corr %>%  ggcorr(label_size = 3, label = TRUE, label_color = "black", hjust = 0.925, size = 3.5, angle = -45) + labs(title = "2006")


el2010 <- eleicoes_2010 %>% select(-partido, -estado_civil, -sexo, -grau)

corr2 = el2010[, 0:14] %>%  cor() %>%  round(2)

corr2 %>%  ggcorr(label_size = 3, label = TRUE, label_color = "black", hjust = 0.925, size = 3.5, angle = -45) + labs(title = "2010")
```


#####Como existe uma correlação bem alta entre algumas variáveis, estas não são úteis para o modelo. Para 2006, a variável total_receita possui correlação muito alta com quase todas as outras variáveis, então podemos remover ela do modelo, bem como a variável quantidade_fornecedores
#####Já para 2010 a variável quantidade_fornecedores mostra alta correlação com quase todas as outras, media_despesa também, assim, podemos remover ambas.

### 4. No caso de haver variáveis pouco explicativas e/ou redudantes, construa um novo modelo sem essas variáveis e o compare ao modelo com todas as variáveis (e.g. em termos de R2 e RSE). Faça isso para 2006 e 2010 separadamente


```{r message=FALSE,  warning=FALSE}
e2006 <- el2006  %>% select(-total_receita, -quantidade_fornecedores)

modelo_novo <- lm(data = e2006, votos ~ ., na.action = na.omit)

modelo_novo %>%   summary()

```


#####Para 2006, mesmo removendo as variáveis categóricas e aquelas que possuiam uma alta correlação com as outras, nosso modelo perdeu pouco mais de 1% de acuracia, o que indica que as variáveis removidas eram pouco úteis para explicação dos dados.

```{r message=FALSE,  warning=FALSE}
e2010 <- el2010  %>% select(-total_receita, -quantidade_despesas)

modelo_novo <- lm(data = e2010, votos ~ ., na.action = na.omit)

modelo_novo %>%   summary()

```


#####Já para 2010, após remover as variáveis categóricas e com alta correlação, a capacidade explicativa do modelo para com os dados caiu de cerca de 47% para 43%. Uma queda maior que a de 2006, mas que ainda é pequena comparada ao benefício de retirar boa parte das variáveis que não contribuíam muito para o modelo.


### 5. Construa agora uma regressão considerando os anos 2006 e 2010 em conjunto. Que diferenças/semelhanças você percebe em relação aos modelos individuais por ano? Veja a questão 2 para sugestões que você usar para comparação.

```{r message=FALSE,  warning=FALSE}
eleicoes <- dados  %>% select(-nome, -sequencial_candidato, -cargo, -ano, -ocupacao, -uf)

modelo_novo <- lm(data = eleicoes, votos ~ ., na.action = na.omit)

modelo_novo %>%   summary()
```

#####De cara percemos que nosso R quadrado e RSL caíram. 
#####Variáveis mais explicativas: recursos_de_pessoas_juridicas, recursos_de_pessoas_fisicas, total_despesa, quantidade_fornecedores e total_receita. As menos explicativas: recursos_proprios, media_despesa, quantidade_doacoes e quantidade_doares.
#####Percebemos uma ligeira mudança quanto as análises individuais, mas a maior foi a variável quantidade_fornecedores se tornando muito explicativa no modelo quando analisamos os dados dos dois anos em conjunto, em contrapartida das análises individuais, onde ela era pouco/pouquíssimo explicativa.



#####Para mais informações acesse: http://www.tse.jus.br/
